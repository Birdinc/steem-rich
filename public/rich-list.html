<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Steem Rich</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
    body {
        padding-top: 70px;
        /* Required padding for .navbar-fixed-top. Remove if using .navbar-static-top. Change if height of navigation changes. */
    }
    </style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://steemrich.com/">Steem Rich</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="rich-list.html">Rich List</a>
                    </li>
                    <li>
                        <a href="rising-stars.html">Rising Stars</a>
                    </li>
                    <li>
                        <a href="steemit-tools.html">Steemit Tools</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Content -->
    <div class="container">

        <div class="row">
            <div class="col-lg-12 text-center">
                <h1>Rich List</h1>
            </div>
        </div>
        <!-- /.row -->

    </div>
    <!-- /.container -->

    <div id="container" class="container">

      <div class="row">
          <div class="form-group col-6">
             <label>User Name</label>
             <input class="form-control" type="text" v-model.lazy="user">
           </div>
      </div>

      <div>
        <pre>{{ userData }}</pre>
      </div>

      <div id="profile-image">
        <img :src="userData.profile_image">
      </div>

    </div>

    <!-- jQuery Version 1.11.1 -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Vue -->
    <script src="//unpkg.com/vue"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bluebird/3.5.0/bluebird.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>

    <!-- Steem API -->
    <script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>

    <script>
       {
         let vm = new Vue({
           el: '#container',
           data: {
             user: 'birdinc',
             userData: {
               profile_image: "",
               level: 0,
               xp: 0,
               power: 0,
               follower_count: 0
             }
           },
           watch: {
             user: function (u) {
               setDefaultUserProfilePic()
               refreshAccountData(u)
             }
           }
         })

         function calcLevel(v) {
           return Math.floor(calcReputation(v))
         }

         function calcXP(v) {
           let r = calcReputation(v);
           return 100 * (r - Math.floor(r))
         }

         function log10(str) {
           let $str = str.toString()
           const leadingDigits = parseInt($str.substring(0, 4))
           const log = Math.log(leadingDigits) / Math.log(10)
           const n = $str.length - 1
           return n + (log - parseInt(log))
         }

         function calcReputation(value) {
           if (value == null || value == 0) return 0;

           let neg = value < 0
           let reputation_level = log10(value) - 9;
           if (reputation_level < 0) reputation_level = 0;
           if (neg) reputation_level *= -1;

           return reputation_level * 9 + 25;
         }

         function setDefaultUserProfilePic() {
           vm.$set(vm.userData, 'profile_image', 'https://www.gravatar.com/avatar/000000000000000000000000000000000?d=mm&amp;f=y')
         }

         function refreshAccountData(accountName) {
           return steem.api.getAccountsAsync([accountName])
             .then(function (result) {
               if (result.length == 0) {
                 vm.userData = {
                   profile_image: "",
                   level: 0,
                   xp: 0,
                   power: 0,
                   follower_count: 0
                 }
                 return
               }

               try {
                 let profile = JSON.parse(result[0].json_metadata).profile

                 if (profile.profile_image != null) {
                   vm.$set(vm.userData, 'profile_image', profile.profile_image)
                 }
               }
               catch (err) {
                 do_setDefaultUserProfilePic()
               }

               steem.api.getFollowCountAsync(accountName)
                   .then(function (result) {
                     vm.$set(vm.userData, 'follower_count', result.follower_count)
                   })

               vm.$set(vm.userData, 'level', calcLevel(result[0].reputation))
               vm.$set(vm.userData, 'xp', calcXP(result[0].reputation))
               vm.$set(vm.userData, 'power', result[0].voting_power / 100)

             })
             .catch(console.error)
         }

         refreshAccountData(vm.user)
       }
 </script>

</body>

</html>
